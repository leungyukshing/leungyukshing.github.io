---
title: 实习面经--Redis基础
tags:
  - 面试总结
mathjax: true
abbrlink: 39920
date: 2019-07-02 11:24:20
---

# 面试总结之Redis基础

&emsp;&emsp;Redis是一个高速缓存数据库，可以在后端配合数据库使用，提高服务的性能，是后端开发面试常考的知识，这里就为大家总结一下常见的考点。总结的部分是结合了教科书、其他面经以及个人的面试经历，相信能够帮助到大家。如果有不足的地方，欢迎大家指出！

&emsp;&emsp;本博客长期更新，欢迎大家收藏、订阅！

<!-- more -->

## 1.redis数据类型

+ 字符串（String）：二进制安全，可以包含任何数据
+ 哈希（Hash）：key-value的模式
+ 列表（List）：双端链表实现
+ 集合（Set）：哈希实现，`insert`、`delete`、`search`的时间复杂度都是$O(1)$
+ 有序集合（Sorted Set）：可以设置权重参数

---

## 2. redis分布式锁

工作原理是：先拿`setnx`来争抢锁，抢到后再用`expire`给锁加一个过期时间，防止锁忘记释放。

如果在拿到锁之后，在`expire`之前遇到了crash，这个锁就永远得不到释放了，我们可以通过将`setnx`和`expire`合并成一条指令使用，`set`提供了这个操作。

---

## 3. 在海量数据中找出已知前缀的key

有两个方法：

+ `keys`指令：单线程，会导致县城阻塞一定的时间，线上服务会停顿，直到命令执行完毕；
+ `scan`指令：无阻塞地提取出指定模式的key列表，会有一定的重复概率。我们可以在客户端做一次去重，获得key列表，但是这个整体花费的时间比用`key`指令要长得多。

---

## 4.队列

使用list结构作为底层，使用`rpush()`生产消息，使用`lpop()`消费消息。当调用`lpop()`时如果队列为空，将会`sleep()`后再重试。也可以使用`blpop()`，阻塞直到队列中有消息可以消费。

满足**生产一次，消费多次**的需求，可使用**pub/sub主题订阅者模式**。缺点是，消费者下线时，生产的消息会丢失。解决这个问题要使用专业的队列，如rabbitmq。

延时队列的实现使用sortedset，时间作为score，消息作为key，生产者调用`zadd`生产消息，消费者使用`zrangebyscore`来获取一定时间内的数据进行处理。

---

## 5.大量key设置同一个时间过期

如果大量的key都是同一个时间过期的话，redis可能会在该时间点卡顿。解决方法是：在时间上增加一个随机值，使过期时间分散开。

---

## 6.redis持久化

+ **bgsave**：镜像全量持久化，耗时长，停机时丢失大量的数据；
+ **aof**：增量持久化

redis实例重启后，使用bgsave持久化文件重建构建内存，再使用aof重放近期的操作指令来恢复重启之间的状态。

+ **突然掉电怎么办？**
  + aof日志可以设置`sync`属性，如果不要求性能，每条指令都`sync`一下磁盘，这样不会丢失数据，但开销太大，实际中不会使用；通常情况是，定时`sync`，1s一次，最多丢失1s的数据
+ **bgsave原理**
  + `fork`：redis通过创建子进程进行bgsave操作
  + `cow`：Copy On Write。父子进程共享数据段。父进程提供读写服务，写脏的页面数据会通过复制逐渐和子进程分离开来。

---

## 7.pipeline操作

如果指令之间没有因果关系，可以实现pipeline。将多次IO往返时间缩短为1次。

---

## 8.redis数据淘汰策略

1. **volatile-LRU**：在**已设置过期时间的数据集**中选**最近最少使用的数据**进行淘汰。
2. **volatile-TTL**：在**已设置过期时间的数据集**中选**将要过期的数据**进行淘汰。
3. **volatile-random**：在**已设置过期时间的数据集**中**随机选取数据**进行淘汰。
4. **allkeys-LRU**：在**全数据集**中选**最近最少使用的数据**进行淘汰。
5. **allkeys-random**：在**全数据集**中**随机选取数据数据**进行淘汰。
6. **no-enviction**：禁止淘汰数据。

---

## Reference

1. [Redis面试题刁难大全](<https://zhuanlan.zhihu.com/p/32540678>)
2. [Redis面经总结](<https://juejin.im/post/5ad6e4066fb9a028d82c4b66>)
3. [Redis跳跃表](<https://juejin.im/post/57fa935b0e3dd90057c50fbc>)

